{% load static %}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ event.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'events/calendar.css' %}" rel="stylesheet">
  </head>
  <body>
    <div class="page-wrap">
      <div class="calendar-card p-4">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h2>{{ event.title }}</h2>
            <div class="text-white">{{ event.start_time }} â€” {{ event.end_time }}</div>
            {% if event.location %}<div class="small">Location: {{ event.location }}</div>{% endif %}
          </div>
          <div>
            <a class="btn btn-sm btn-outline-light" href="{% url 'calendar' %}">Back to calendar</a>
          </div>
        </div>

        <div class="mb-3">
          <h5>Description</h5>
          <p>{{ event.description|default:'(no description)' }}</p>
        </div>

        <div class="mb-3">
          <h5>Organizers</h5>
          <ul>
            {% if event.owner %}
              <li>
                {% if event.owner.first_name or event.owner.last_name %}
                  {{ event.owner.first_name }} {{ event.owner.last_name }}
                {% else %}
                  {{ event.owner.username }}
                {% endif %}
                <small class="text-white">(Owner)</small>
              </li>
            {% endif %}

            {% for u in event.organizers.all %}
              {% if event.owner and u.id == event.owner.id %}
                {# skip duplicate owner entry #}
              {% else %}
                <li>
                  {% if u.first_name or u.last_name %}
                    {{ u.first_name }} {{ u.last_name }}
                  {% else %}
                    {{ u.username }}
                  {% endif %}
                </li>
              {% endif %}
            {% empty %}
              {% if not event.owner %}
                <li class="text-white">Unknown</li>
              {% endif %}
            {% endfor %}
          </ul>
        </div>

        <div class="mb-3">
          {% if event.attendees.count %}
            <h5>Attended ({{ event.attendees.count }})</h5>
            <ul>
              {% for u in event.attendees.all %}
                <li>{{ u.username }}</li>
              {% empty %}
                <li class="text-white">No one has been marked as attended.</li>
              {% endfor %}
            </ul>
          {% else %}
            <h5>Participants ({{ event.participants.count }})</h5>
            <ul>
              {% for u in event.participants.all %}
                <li>{{ u.username }}</li>
              {% empty %}
                <li class="text-white">No participants yet.</li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>

        <div class="mb-3">
          {% if request.user.is_authenticated %}
            {% if request.user in event.participants.all %}
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="leave">
                <button class="btn btn-outline-light" type="submit">Leave</button>
              </form>
            {% else %}
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="join">
                <button class="btn btn-primary" type="submit">Join</button>
              </form>
            {% endif %}
          {% else %}
            <p class="text-white">Please <a href="{% url 'login' %}?next={% url 'event_detail' event.id %}">log in</a> to join this event.</p>
          {% endif %}
        </div>

        <div class="mb-3 d-flex align-items-center gap-2">
          {% if request.user.is_authenticated %}
            <a class="btn btn-sm btn-outline-light me-2" href="{% url 'event_gallery' event.id %}#upload">View gallery ({{ images.count }})</a>
          {% else %}
            <a class="btn btn-sm btn-outline-light me-2" href="{% url 'event_gallery' event.id %}">View gallery ({{ images.count }})</a>
          {% endif %}
          {% if request.user.is_authenticated %}
            <form method="post" enctype="multipart/form-data" action="{% url 'upload_event_image' event.id %}" class="d-flex align-items-center upload-form">
              {% csrf_token %}
              <label for="id_image_input" class="btn btn-primary upload-btn">ðŸ“· Add photo</label>
              <input id="id_image_input" type="file" name="image" accept="image/*" class="d-none" required>
              <span id="selected_filename" class="text-white small ms-2 upload-filename">No file chosen</span>
              <button class="btn btn-sm btn-outline-light ms-2 upload-submit" type="submit">Send</button>
            </form>
            {% comment %} Allow owner or existing organizers to manage organizers via the edit page {% endcomment %}
          {% else %}
            <span class="text-white">Log in to upload photos.</span>
          {% endif %}
        </div>

        <script>
          (function(){
            const input = document.getElementById('id_image_input');
            const label = document.querySelector('.upload-btn');
            const filename = document.getElementById('selected_filename');
            if(input){
              input.addEventListener('change', function(){
                const f = input.files && input.files.length ? input.files[0].name : 'No file chosen';
                filename.textContent = f;
                // enable submit when a file is selected
                const submit = document.querySelector('.upload-submit');
                if(submit) submit.disabled = !input.files.length;
              });
              // initialize submit state
              const submit = document.querySelector('.upload-submit');
              if(submit) submit.disabled = true;
            }
          })();
        </script>

        {% if request.user == event.owner and event.end_time <= now %}
          <div class="mb-3">
            <a class="btn btn-warning" href="{% url 'mark_attendance' event.id %}">Manage Attendance</a>
          </div>
        {% endif %}

      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
