{% load static %}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gallery — {{ event.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'events/calendar.css' %}" rel="stylesheet">
  </head>
  <body>
    <div class="page-wrap">
      <div class="calendar-card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>Gallery — {{ event.title }}</h3>
          <div>
            <a class="btn btn-sm btn-outline-light me-2" href="{% url 'event_detail' event.id %}">Back</a>
            {% if request.user.is_authenticated %}
              <a class="btn btn-sm btn-primary" href="#upload">Upload photo</a>
            {% endif %}
          </div>
        </div>

        {% if images %}
          <!-- JS-driven Masonry grid. grid-sizer defines column width for Masonry. -->
          <div class="grid" id="gallery-grid">
            <div class="grid-sizer"></div>
            {% for img in images %}
              <div class="grid-item">
                <a href="{{ img.image.url }}" target="_blank">
                  <img src="{{ img.image.url }}" alt="Photo" class="gallery-thumb" loading="lazy">
                </a>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-white">No photos yet for this event.</p>
        {% endif %}

        {% if request.user.is_authenticated %}
          <hr>
          <h5 id="upload">Upload photos</h5>
          <form method="post" enctype="multipart/form-data" action="{% url 'upload_event_image' event.id %}" class="mb-3" id="gallery-upload-form">
            {% csrf_token %}
            <div class="upload-dropzone p-4 mb-2 rounded" id="dropzone">
              <input type="file" name="images" id="dz-input" accept="image/*" multiple class="d-none" required>
              <div class="d-flex flex-column align-items-center text-center">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-2">
                  <path d="M12 16V8" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M8 12L12 8L16 12" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="3" width="18" height="14" rx="2" stroke="#fff" stroke-width="1.2"/>
                </svg>
                <strong class="text-white">Drag & drop images here, or <button type="button" class="btn btn-link text-decoration-none p-0" id="dz-browse">browse</button></strong>
                <small class="text-white">You can upload multiple photos at once. Max file size depends on server settings.</small>
              </div>
            </div>

            <div id="dz-preview" class="d-flex flex-wrap gap-2 mb-2"></div>

            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-primary" type="submit" id="dz-submit" disabled>Upload photos</button>
              <button type="button" class="btn btn-outline-light" id="dz-clear">Clear</button>
              <div id="dz-count" class="text-white small ms-2">No files selected</div>
            </div>
          </form>
        {% endif %}

      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Drag & drop + preview for gallery upload
      (function(){
        const dropzone = document.getElementById('dropzone');
        const input = document.getElementById('dz-input');
        const browseBtn = document.getElementById('dz-browse');
        const preview = document.getElementById('dz-preview');
        const submit = document.getElementById('dz-submit');
        const clearBtn = document.getElementById('dz-clear');
        const count = document.getElementById('dz-count');

        function updateState(){
          const files = input.files ? Array.from(input.files) : [];
          preview.innerHTML = '';
          if(files.length === 0){
            count.textContent = 'No files selected';
            submit.disabled = true;
            return;
          }
          files.forEach(f => {
            const url = URL.createObjectURL(f);
            const img = document.createElement('img');
            img.src = url;
            img.className = 'dz-thumb me-1 mb-1';
            preview.appendChild(img);
          });
          count.textContent = `${files.length} file(s) selected`;
          submit.disabled = false;
        }

        if(dropzone){
          dropzone.addEventListener('click', () => input.click());
          browseBtn.addEventListener('click', () => input.click());

          dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
          dropzone.addEventListener('dragleave', e => { e.preventDefault(); dropzone.classList.remove('dragover'); });
          dropzone.addEventListener('drop', e => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            if(e.dataTransfer && e.dataTransfer.files){
              input.files = e.dataTransfer.files;
              updateState();
            }
          });

          input.addEventListener('change', updateState);
          clearBtn.addEventListener('click', () => { input.value = ''; updateState(); });

          // If opened with anchor, focus and scroll
          if(window.location.hash === '#upload'){
            const el = document.getElementById('upload');
            if(el){ el.scrollIntoView({behavior: 'smooth', block: 'center'}); }
            try{ input.focus(); }catch(e){}
          }
        }
      })();
    </script>
    <!-- imagesLoaded + Masonry for animated masonry layout -->
    <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script>
      // Initialize Masonry when images are ready
      (function(){
        const grid = document.querySelector('#gallery-grid');
        if(!grid) return;
        // Wait until images have loaded then initialize Masonry for animated layout
        imagesLoaded( grid, function() {
          // eslint-disable-next-line no-undef
          const msnry = new Masonry( grid, {
            itemSelector: '.grid-item',
            columnWidth: '.grid-sizer',
            percentPosition: true,
            transitionDuration: '0.28s'
            /* removed pixel-based gutter so CSS percentage padding/margins
               control spacing responsively (no px used) */
          });
          // ensure layout on window resize with debounce
          let rt;
          window.addEventListener('resize', function(){
            clearTimeout(rt);
            rt = setTimeout(function(){ msnry.layout(); }, 150);
          });
        });
      })();
    </script>
  </body>
</html>
