{% load static %}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gallery — {{ event.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'events/calendar.css' %}" rel="stylesheet">
      <style>
        /* Selection overlay styles for gallery images */
        .grid-item { cursor: pointer; }
        .grid-item .grid-item-inner { position: relative; overflow: hidden; border-radius: 6px; }
        .gallery-thumb { display: block; width: 100%; height: auto; border-radius: 6px; transition: transform .12s ease, box-shadow .12s ease; }
        .grid-item.selected .gallery-thumb { transform: scale(.98); box-shadow: 0 0 0 3px rgba(0,123,255,0.18) inset; }
        .select-overlay { position: absolute; inset: 0; display: flex; align-items: flex-start; justify-content: flex-end; padding: 8px; pointer-events: none; }
        .select-overlay .check { width: 28px; height: 28px; background: rgba(0,123,255,0.95); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: #fff; opacity: 0; transform: scale(.7); transition: opacity .12s, transform .12s; }
        .grid-item.selected .select-overlay .check { opacity: 1; transform: scale(1); }
        .view-link { position:absolute; top: 8px; left: 8px; z-index: 5; background: rgba(0,0,0,0.45); color: #fff; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; border-radius: 100%; text-decoration: none; border-width: 0px; }
        .view-link svg { width: 16px; height: 16px; }
        /* small thumbnail preview in dropzone and gallery consistent sizing */
        .dz-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; }
      </style>
  </head>
  <body>
    <div class="page-wrap">
      <div class="calendar-card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>Gallery — {{ event.title }}</h3>
          <div>
            <a class="btn btn-sm btn-outline-light me-2" href="{% url 'event_detail' event.id %}">Back</a>
            {% if request.user.is_authenticated %}
              <a class="btn btn-sm btn-primary" href="#upload">Upload photo</a>
            {% endif %}
          </div>
        </div>

        {% if images %}
          <!-- Download form wraps the grid so selected checkboxes are submitted -->
          <form id="download-form" method="post" action="{% url 'download_event_images' event.id %}">
            {% csrf_token %}
            <!-- JS-driven Masonry grid. grid-sizer defines column width for Masonry. -->
            <div class="d-flex mb-2">
              <div class="flex-grow-1"></div>
              <button id="download-selected" type="submit" class="btn btn-sm btn-success ms-2" disabled>Download selected</button>
              <button id="delete-selected" type="button" class="btn btn-sm btn-danger ms-2" disabled>Delete selected</button>
            </div>
            <div class="grid" id="gallery-grid">
            <div class="grid-sizer"></div>
            {% for img in images %}
              <div class="grid-item" data-img-id="{{ img.id }}">
                <div class="grid-item-inner">
                  <a href="{{ img.image.url }}" target="_blank" class="view-link" title="Open image" onclick="event.stopPropagation();">
                    <!-- eye / open icon -->
                    <div style="
                      display: inline-flex;
                      align-items: center;
                      justify-content: center;
                      width: 32px;
                      height: 32px;
                      background: #222;
                      border-radius: 50%;
                      overflow: hidden;            /* <- clips any square corners */
                      background-clip: padding-box;/* <- avoids bleed from borders */
                    ">
                      <svg viewBox="0 0 24 24" fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                          aria-hidden="true"
                          width="16" height="16"
                          style="display:block; background:transparent;"> <!-- no svg bg -->
                        <path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z"
                              stroke="#fff" stroke-width="1.2"
                              stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="12" r="3"
                                stroke="#fff" stroke-width="1.2"
                                stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>



                  </a>
                  <img src="{{ img.image.url }}" alt="Photo" class="gallery-thumb" loading="lazy" draggable="false">
                  <input type="checkbox" name="selected_images" value="{{ img.id }}" class="img-select-input d-none">
                  <div class="select-overlay" aria-hidden="true">
                    <div class="check" aria-hidden="true">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
            </div>
          </form>
        {% else %}
          <p class="text-white">No photos yet for this event.</p>
        {% endif %}

        {% if request.user.is_authenticated %}
          <hr>
          <h5 id="upload">Upload photos</h5>
          <form method="post" enctype="multipart/form-data" action="{% url 'upload_event_image' event.id %}" class="mb-3" id="gallery-upload-form">
            {% csrf_token %}
            <div class="upload-dropzone p-4 mb-2 rounded" id="dropzone">
              <input type="file" name="images" id="dz-input" accept="image/*" multiple class="d-none" required>
              <div class="d-flex flex-column align-items-center text-center">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mb-2">
                  <path d="M12 16V8" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M8 12L12 8L16 12" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="3" width="18" height="14" rx="2" stroke="#fff" stroke-width="1.2"/>
                </svg>
                <strong class="text-white">Drag & drop images here, or <button type="button" class="btn btn-link text-decoration-none p-0" id="dz-browse">browse</button></strong>
                <small class="text-white">You can upload multiple photos at once. Max file size depends on server settings.</small>
              </div>
            </div>

            <div id="dz-preview" class="d-flex flex-wrap gap-2 mb-2"></div>

            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-primary" type="submit" id="dz-submit" disabled>Upload photos</button>
              <button type="button" class="btn btn-outline-light" id="dz-clear">Clear</button>
              <div id="dz-count" class="text-white small ms-2">No files selected</div>
            </div>
          </form>
        {% endif %}

      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Drag & drop + preview for gallery upload
      (function(){
        const dropzone = document.getElementById('dropzone');
        const input = document.getElementById('dz-input');
        const browseBtn = document.getElementById('dz-browse');
        const preview = document.getElementById('dz-preview');
        const submit = document.getElementById('dz-submit');
        const clearBtn = document.getElementById('dz-clear');
        const count = document.getElementById('dz-count');

        function updateState(){
          const files = input.files ? Array.from(input.files) : [];
          preview.innerHTML = '';
          if(files.length === 0){
            count.textContent = 'No files selected';
            submit.disabled = true;
            return;
          }
          files.forEach(f => {
            const url = URL.createObjectURL(f);
            const img = document.createElement('img');
            img.src = url;
            img.className = 'dz-thumb me-1 mb-1';
            preview.appendChild(img);
          });
          count.textContent = `${files.length} file(s) selected`;
          submit.disabled = false;
        }

        if(dropzone){
          dropzone.addEventListener('click', () => input.click());
          browseBtn.addEventListener('click', () => input.click());

          dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
          dropzone.addEventListener('dragleave', e => { e.preventDefault(); dropzone.classList.remove('dragover'); });
          dropzone.addEventListener('drop', e => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            if(e.dataTransfer && e.dataTransfer.files){
              input.files = e.dataTransfer.files;
              updateState();
            }
          });

          input.addEventListener('change', updateState);
          clearBtn.addEventListener('click', () => { input.value = ''; updateState(); });

          // If opened with anchor, focus and scroll
          if(window.location.hash === '#upload'){
            const el = document.getElementById('upload');
            if(el){ el.scrollIntoView({behavior: 'smooth', block: 'center'}); }
            try{ input.focus(); }catch(e){}
          }
        }
      })();
    </script>
    <!-- imagesLoaded + Masonry for animated masonry layout -->
    <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script>
      // Initialize Masonry when images are ready
      (function(){
        const grid = document.querySelector('#gallery-grid');
        if(!grid) return;
        // Wait until images have loaded then initialize Masonry for animated layout
        imagesLoaded( grid, function() {
          // eslint-disable-next-line no-undef
          const msnry = new Masonry( grid, {
            itemSelector: '.grid-item',
            columnWidth: '.grid-sizer',
            percentPosition: true,
            transitionDuration: '0.28s'
            /* removed pixel-based gutter so CSS percentage padding/margins
               control spacing responsively (no px used) */
          });
          // ensure layout on window resize with debounce
          let rt;
          window.addEventListener('resize', function(){
            clearTimeout(rt);
            rt = setTimeout(function(){ msnry.layout(); }, 150);
          });
          // Initialize selection handlers so clicking images toggles selection
          function initImageSelection(){
            grid.querySelectorAll('.grid-item').forEach(item => {
              // make items keyboard-focusable
              if(!item.hasAttribute('tabindex')) item.setAttribute('tabindex','0');
              item.addEventListener('click', function(){
                item.classList.toggle('selected');
                const chk = item.querySelector('.img-select-input');
                if(chk) chk.checked = item.classList.contains('selected');
                updateDownloadButton();
                // ensure Masonry re-layout to keep visuals consistent
                try{ msnry.layout(); }catch(e){}
              });
              item.addEventListener('keydown', function(e){
                if(e.key === ' ' || e.key === 'Enter'){
                  e.preventDefault();
                  item.click();
                }
              });
              // ensure view-link doesn't trigger selection
              const view = item.querySelector('.view-link');
              if(view){ view.addEventListener('click', function(ev){ ev.stopPropagation(); }); }
            });
          }
          // enable/disable download button depending on selection
          const downloadBtn = document.getElementById('download-selected');
          function updateDownloadButton(){
            if(!downloadBtn) return;
            const any = Array.from(grid.querySelectorAll('.img-select-input')).some(i => i.checked);
            downloadBtn.disabled = !any;
          }

          // run selection init after layout
          initImageSelection();
          // watch checkboxes in case they change externally
          grid.addEventListener('change', function(e){ if(e.target && e.target.classList.contains('img-select-input')) updateDownloadButton(); });
          // initial state
          updateDownloadButton();

          // Intercept the download form submission and trigger separate downloads
          const downloadForm = document.getElementById('download-form');
          if(downloadForm){
            downloadForm.addEventListener('submit', async function(ev){
              ev.preventDefault();
              const btn = document.getElementById('download-selected');
              if(!btn) return;
              const selectedItems = Array.from(grid.querySelectorAll('.grid-item')).filter(it => {
                const chk = it.querySelector('.img-select-input');
                return chk && chk.checked;
              });
              if(selectedItems.length === 0){
                // nothing selected; give quick feedback
                btn.blur();
                return;
              }

              // disable while downloading
              const origText = btn.textContent;
              btn.disabled = true;
              btn.textContent = `Downloading 0/${selectedItems.length}...`;

              let completed = 0;
              // helper to derive filename from URL
              function filenameFromUrl(u){
                try{ const p = new URL(u, window.location.href).pathname; return p.split('/').pop() || 'image'; }catch(e){ return 'image'; }
              }

              for(const item of selectedItems){
                const imgEl = item.querySelector('img.gallery-thumb');
                if(!imgEl) { completed++; btn.textContent = `Downloading ${completed}/${selectedItems.length}...`; continue; }
                const src = imgEl.src;
                try{
                  const resp = await fetch(src, { credentials: 'same-origin' });
                  if(!resp.ok) throw new Error('fetch failed');
                  const blob = await resp.blob();
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = filenameFromUrl(src);
                  document.body.appendChild(a);
                  a.click();
                  // cleanup
                  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 2000);
                }catch(err){
                  // continue to next image on error
                }finally{
                  completed++;
                  btn.textContent = `Downloading ${completed}/${selectedItems.length}...`;
                }
                // small pause to avoid browser blocking multiple rapid downloads
                await new Promise(r => setTimeout(r, 180));
              }

              // restore button
              btn.textContent = origText;
              btn.disabled = false;
            });
          }

          // Delete selected images via AJAX
          const deleteBtn = document.getElementById('delete-selected');
          function updateDeleteButton(){
            if(!deleteBtn) return;
            const any = Array.from(grid.querySelectorAll('.img-select-input')).some(i => i.checked);
            deleteBtn.disabled = !any;
          }
          if(deleteBtn){
            deleteBtn.addEventListener('click', async function(){
              const selectedIds = Array.from(grid.querySelectorAll('.img-select-input:checked')).map(i => i.value);
              if(selectedIds.length === 0) return;
              if(!confirm(`Delete ${selectedIds.length} selected image(s)? This cannot be undone.`)) return;

              // disable while processing
              deleteBtn.disabled = true;
              deleteBtn.textContent = `Deleting 0/${selectedIds.length}...`;

              const csrfEl = downloadForm ? downloadForm.querySelector('input[name="csrfmiddlewaretoken"]') : null;
              const csrf = csrfEl ? csrfEl.value : '';
              const deleteUrl = downloadForm ? downloadForm.dataset.deleteUrl : null;
              if(!deleteUrl){ alert('Delete URL not configured.'); return; }

              const formData = new FormData();
              if(csrf) formData.append('csrfmiddlewaretoken', csrf);
              selectedIds.forEach(id => formData.append('selected_images', id));

              try{
                const resp = await fetch(deleteUrl, { method: 'POST', body: formData, credentials: 'same-origin', headers: {'X-Requested-With': 'XMLHttpRequest'} });
                if(!resp.ok) throw new Error('request failed');
                const data = await resp.json();
                const deleted = data.deleted || [];
                let i=0;
                for(const id of deleted){
                  const el = grid.querySelector(`[data-img-id="${id}"]`);
                  if(el){
                    try{ msnry.remove(el); }catch(e){ el.remove(); }
                  }
                  i++;
                  deleteBtn.textContent = `Deleting ${i}/${deleted.length}...`;
                }
                // final layout
                try{ msnry.layout(); }catch(e){}
              }catch(err){
                alert('Failed to delete selected images.');
              }finally{
                deleteBtn.textContent = 'Delete selected';
                deleteBtn.disabled = false;
                // update buttons state
                updateDownloadButton();
                updateDeleteButton();
              }
            });
          }

          // make sure delete button state follows selections
          grid.addEventListener('change', function(e){ if(e.target && e.target.classList.contains('img-select-input')) updateDeleteButton(); });
          updateDeleteButton();
        });
      })();
    </script>
  </body>
</html>
