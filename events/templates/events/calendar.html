<!doctype html>
{% load static %}
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Events Calendar</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 (CSS only for styling; JS added at bottom) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <link href="{% static 'events/calendar.css' %}" rel="stylesheet">
    <!-- Inline overrides (high specificity) to force cream/teal theme; remove after verification -->
    <style>
      html, body { background: linear-gradient(180deg, #fbf6ef 0%, #e6f7f2 100%) !important; color: #063B36 !important; }
      .page-wrap { background: transparent !important; }
      .calendar-card { background: #ffffff !important; color: #063B36 !important; border-color: rgba(6,59,54,0.06) !important; }
      .brand .logo { background: linear-gradient(135deg,#0d9488,#0ea5a4) !important; }
      .btn-primary, .fc .fc-button-primary { background-color: #0d9488 !important; border-color: #0d9488 !important; }
      .btn-outline-light { color: #063B36 !important; border-color: rgba(6,59,54,0.12) !important; }
      .modal-content { background: #ffffff !important; color: #063B36 !important; }
      .fc .fc-daygrid-day, .fc .fc-daygrid-day-frame, .fc .fc-scroller { background: transparent !important; color: #063B36 !important; }
      .fc .fc-col-header-cell, .fc .fc-daygrid-day-number { color: #063B36 !important; }
      .fc .fc-event, .fc .fc-daygrid-event { background: linear-gradient(135deg,#0d9488,#0ea5a4) !important; color: #fff !important; }
    </style>
  </head>
  <body>

    <div class="page-wrap">
      <div class="calendar-card">
        <div class="calendar-header">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
              <h1>Events Calendar</h1>
            </div>
          </div>

          <div>
            <!-- small controls area; FullCalendar will render its toolbar inside the calendar container but this keeps header balanced -->
            <a href="#" class="btn btn-sm btn-outline-light me-2" onclick="location.reload();">Refresh</a>

            {% if request.user.is_authenticated %}
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  {{ request.user.username }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="{% url 'myevents' %}">My events</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form method="post" action="{% url 'logout' %}" class="m-0">
                      {% csrf_token %}
                      <button type="submit" class="dropdown-item text-danger">Log out</button>
                    </form>
                  </li>
                </ul>
              </div>
            {% else %}
              <a href="{% url 'login' %}" class="btn btn-sm btn-outline-light">Log in</a>
            {% endif %}
          </div>
        </div>

        <div id="calendar"></div>
      </div>
    </div>

    <!-- Event details modal (Bootstrap) -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
  <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title" id="eventModalLabel">Event</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="ev-time" class="text-muted mb-1"></p>
            <h4 id="ev-title"></h4>
            <p id="ev-desc" class="mt-3"></p>
            <div id="ev-extra" class="small text-muted"></div>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (Popper included) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const calendarEl = document.getElementById('calendar');

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          themeSystem: 'standard',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
          },
          buttonText: {
            today: 'Today',
            month: 'Month',
            week: 'Week',
            day: 'Day',
            list: 'List'
          },
          navLinks: true,
          nowIndicator: true,
          dayMaxEvents: true,
          events: '/events-json/',
          height: 'auto',
          contentHeight: 'auto',
          expandRows: true,

          eventDidMount: function(info){
            // style by event extendedProps.color or fallback palette
            const color = info.event.extendedProps.color || info.event.backgroundColor || null;
            if(color){
              info.el.style.background = color;
            } else {
              // default gradient for events without color
              info.el.style.background = 'linear-gradient(135deg,#7c3aed,#06b6d4)';
            }
            info.el.style.borderRadius = '8px';
          },

          eventClick: function(info){
            info.jsEvent.preventDefault();
            const ev = info.event;
            const modal = new bootstrap.Modal(document.getElementById('eventModal'));

            // Fill modal
            document.getElementById('ev-title').textContent = ev.title || '(no title)';

            const start = ev.start ? new Date(ev.start) : null;
            const end = ev.end ? new Date(ev.end) : null;
            let timeStr = '';
            if(start && end){
              timeStr = start.toLocaleString() + ' — ' + end.toLocaleString();
            } else if(start){
              timeStr = start.toLocaleString();
            } else {
              timeStr = '';
            }
            document.getElementById('ev-time').textContent = timeStr;

            const desc = ev.extendedProps && ev.extendedProps.description ? ev.extendedProps.description : '';
            document.getElementById('ev-desc').textContent = desc;

            // any extra props
            const extra = [];
            if(ev.extendedProps && ev.extendedProps.location) extra.push('Location: ' + ev.extendedProps.location);
            document.getElementById('ev-extra').textContent = extra.join(' • ');

            modal.show();
          }
        });

        calendar.render();
      });
    </script>
  </body>
</html>
