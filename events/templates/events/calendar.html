<!doctype html>
{% load static %}
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Events Calendar</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 (CSS only for styling; JS added at bottom) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <link href="{% static 'events/calendar.css' %}" rel="stylesheet">
    
  </head>
  <body>

    <div class="page-wrap">
      <div class="calendar-card">
        <div class="calendar-header">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
              <h1>Events Calendar</h1>
            </div>
          </div>

          <div class="d-flex align-items-center">
            <!-- small controls area; FullCalendar will render its toolbar inside the calendar container but this keeps header balanced -->
            <a href="#" class="btn btn-sm btn-outline-light me-2" onclick="location.reload();">Refresh</a>

            <!-- Country filter -->
            <select id="id_country_filter" class="form-select form-select-sm me-2" style="width:200px">
              <option value="">All countries</option>
              {% for c in countries %}
                <option value="{{ c.id }}" data-flag="{{ c.flag_url|default:'' }}" {% if selected_country|stringformat:"s" == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>

            <!-- Community filter -->
            <select id="id_community_filter" class="form-select form-select-sm me-2" style="width:200px">
              <option value="">All communities</option>
              <option value="bucharest" {% if selected_community == 'bucharest' %}selected{% endif %}>Bucharest (all sectors)</option>
              {# Bucharest aggregate option and optgroup for sectors #}
              <optgroup label="Bucharest">
                {% for com in communities %}
                  {% if com.name in sectors_list %}
                    <option value="{{ com.id }}" {% if selected_community|stringformat:"s" == com.id|stringformat:"s" %}selected{% endif %}>{{ com.name }}</option>
                  {% endif %}
                {% endfor %}
              </optgroup>
              {% for com in communities %}
                {% if com.name not in sectors_list %}
                  <option value="{{ com.id }}" {% if selected_community|stringformat:"s" == com.id|stringformat:"s" %}selected{% endif %}>{{ com.name }}</option>
                {% endif %}
              {% endfor %}
            </select>

            {% if request.user.is_authenticated %}
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  {% if request.user.first_name or request.user.last_name %}
                    {{ request.user.first_name }} {{ request.user.last_name }}
                  {% else %}
                    {{ request.user.username }}
                  {% endif %}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="{% url 'myevents' %}">My events</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form method="post" action="{% url 'logout' %}" class="m-0">
                      {% csrf_token %}
                      <button type="submit" class="dropdown-item text-danger">Log out</button>
                    </form>
                  </li>
                </ul>
              </div>
            {% else %}
              <a href="{% url 'login' %}" class="btn btn-sm btn-outline-light">Log in</a>
            {% endif %}
          </div>
        </div>

  <div id="calendar"></div>
      </div>
    </div>

    <!-- Event details modal (Bootstrap) -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
  <div class="modal-content bg-dark text-white">
          <div class="modal-header border-0">
            <h5 class="modal-title" id="eventModalLabel">Event</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="ev-time" class="text-white mb-1"></p>
            <h4 id="ev-title"></h4>
            <p id="ev-desc" class="mt-3"></p>
            <div id="ev-extra" class="text-white"></div>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (Popper included) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const calendarEl = document.getElementById('calendar');
  // Preload full communities data for client-side filtering when country changes
  const allCommunities = JSON.parse('{{ all_communities_json|escapejs }}');
  const sectorsList = JSON.parse('{{ sectors_list_json|escapejs }}');

  const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          themeSystem: 'standard',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
          },
          buttonText: {
            today: 'Today',
            month: 'Month',
            week: 'Week',
            day: 'Day',
            list: 'List'
          },
          navLinks: true,
          nowIndicator: true,
          dayMaxEvents: true,
          events: '/events-json/',
          height: 'auto',
          contentHeight: 'auto',
          expandRows: true,

          eventDidMount: function(info){
            // style by event extendedProps.color or fallback palette
            const color = info.event.extendedProps.color || info.event.backgroundColor || null;
            if(color){
              info.el.style.background = color;
            } else {
              // default gradient for events without color
              info.el.style.background = 'linear-gradient(135deg,#7c3aed,#06b6d4)';
            }
            info.el.style.borderRadius = '8px';
          },

          eventClick: function(info){
            // Directly navigate to the event detail page when an event is clicked.
            info.jsEvent.preventDefault();
            const ev = info.event;
            const orig = (ev.extendedProps && ev.extendedProps.orig_id) || (ev.id ? ev.id.split('-')[0] : null);
            if(orig){
              window.location.href = '/events/' + encodeURIComponent(orig) + '/';
            } else {
              // fallback: do nothing or open the modal if id can't be determined
              console.warn('Could not determine original event id for navigation:', ev.id, ev.extendedProps);
            }
          }
        });

        // helper to build query string from selected filters
        function buildParams() {
          const country = document.getElementById('id_country_filter').value;
          const community = document.getElementById('id_community_filter').value;
          const parts = [];
          if(country) parts.push('country=' + encodeURIComponent(country));
          if(community) parts.push('community=' + encodeURIComponent(community));
          return parts.length ? ('?' + parts.join('&')) : '';
        }

        // initialize events source with any pre-selected filters
        const initialParams = buildParams();
        calendar.setOption('events', '/events-json/' + initialParams);

        // when filter changes, update events source and refetch
        ['id_country_filter', 'id_community_filter'].forEach(id => {
          const el = document.getElementById(id);
          if(el){
            el.addEventListener('change', () => {
              const params = buildParams();
              calendar.setOption('events', '/events-json/' + params);
              calendar.refetchEvents();
            });
          }
        });

        calendar.render();

        // Client-side community filtering: when country selection changes,
        // rebuild the community dropdown so users cannot pick communities
        // that belong to other countries.
        (function(){
          const countrySel = document.getElementById('id_country_filter');
          const communitySel = document.getElementById('id_community_filter');
          function rebuildCommunities(selectedCountry){
            // clear existing options
            while (communitySel.firstChild) communitySel.removeChild(communitySel.firstChild);
            // add default option
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = 'All communities';
            communitySel.appendChild(defaultOpt);

            // filter communities by selectedCountry (selectedCountry is string of id)
            const filtered = selectedCountry ? allCommunities.filter(c => String(c.country_id) === String(selectedCountry)) : allCommunities.slice();

            // If any of the filtered communities match sectorsList, add a 'Bucharest' aggregate
            const bucharestSectors = filtered.filter(c => sectorsList.includes(c.name));
            if(bucharestSectors.length){
              const buchOpt = document.createElement('option');
              buchOpt.value = 'bucharest';
              buchOpt.textContent = 'Bucharest (all sectors)';
              communitySel.appendChild(buchOpt);

              const optg = document.createElement('optgroup');
              optg.label = 'Bucharest';
              bucharestSectors.forEach(c => {
                const o = document.createElement('option');
                o.value = String(c.id);
                o.textContent = c.name;
                optg.appendChild(o);
              });
              communitySel.appendChild(optg);
            }

            // Add remaining communities that are not Bucharest sectors
            filtered.filter(c => !sectorsList.includes(c.name)).forEach(c => {
              const o = document.createElement('option');
              o.value = String(c.id);
              o.textContent = c.name;
              communitySel.appendChild(o);
            });

            // preserve selected community when possible
            const current = '{{ selected_community|escapejs }}';
            if(current){
              const match = Array.from(communitySel.options).find(opt => opt.value === current);
              if(match) communitySel.value = current;
            }
          }

          if(countrySel && communitySel){
            countrySel.addEventListener('change', () => {
              const val = countrySel.value;
              rebuildCommunities(val);
            });
            // initial build to ensure client-side and server-side match
            rebuildCommunities(countrySel.value || '{{ selected_country|escapejs }}');
          }
        })();

        // Ensure day numbers are styled correctly across FullCalendar variants.
        function styleDayNumbers() {
          // Read CSS variables from :root so JS styling follows the CSS config
          const root = getComputedStyle(document.documentElement);
          const bubbleBg = (root.getPropertyValue('--day-bubble-bg') || '#4026a6').trim();
          const bubbleColor = (root.getPropertyValue('--day-bubble-color') || '#ffffff').trim();
          const todayBg = (root.getPropertyValue('--day-today-bg') || '#170b45').trim();
          const todayBoxShadow = (root.getPropertyValue('--day-today-box-shadow') || '0 8px 24px rgba(6,182,212,0.24)').trim();
            const bubbleSize = (root.getPropertyValue('--day-bubble-size') || '34px').trim();

          // selectors that might contain the day number across versions
          const selectors = [
            '.fc-daygrid-day-number',
            '.fc-daygrid-day-top a',
            '.fc-daygrid-day-top > a',
            '.fc-daygrid-day-top .fc-daygrid-day-number',
          ];

          const elems = new Set();
          selectors.forEach(sel => document.querySelectorAll(sel).forEach(e => elems.add(e)));

          elems.forEach(el => {
            // the element might be an <a> or a <div>; style inline to override transient FC styles
            el.style.display = 'inline-block';
              el.style.width = bubbleSize;
              el.style.height = bubbleSize;
              el.style.lineHeight = bubbleSize;
              el.style.padding = '0';
            el.style.borderRadius = '50%';
            el.style.textAlign = 'center';
            el.style.fontWeight = '600';
            el.style.color = bubbleColor;
            el.style.background = bubbleBg;
            el.style.boxShadow = '0 2px 6px rgba(2,6,23,0.15)';
            // remove any underline/border from anchors or default link styles
            el.style.textDecoration = 'none';
            el.style.textDecorationLine = 'none';
            el.style.borderBottom = 'none';
          });

          // style today's number specifically
          document.querySelectorAll('.fc-day-today').forEach(day => {
            const num = day.querySelector('.fc-daygrid-day-number') || day.querySelector('.fc-daygrid-day-top a');
            if (num) {
            num.style.width = bubbleSize;
            num.style.height = bubbleSize;
            num.style.lineHeight = bubbleSize;
            num.style.background = todayBg;
            num.style.color = bubbleColor;
            num.style.boxShadow = todayBoxShadow;
            num.style.boxSizing = 'border-box';
            num.style.textDecoration = 'none';
            num.style.borderBottom = 'none';
            }
          });
        }

        // run once after render
        setTimeout(styleDayNumbers, 80);

        // re-run when the calendar updates (e.g., navigation). Use a MutationObserver on the calendar element.
        const mo = new MutationObserver(() => styleDayNumbers());
        mo.observe(calendarEl, { childList: true, subtree: true });
      });
    </script>
  </body>
</html>
